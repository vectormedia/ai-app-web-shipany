# ShipAny Template Two - 代码文件路径结构和数据表总结

## 项目文件结构

### 根目录结构
```
shipany-template/
├── .env.example                 # 环境变量模板
├── .gitignore                  # Git 忽略配置
├── CLAUDE.md                   # Claude 使用指南
├── README.md                   # 项目说明文档
├── components.json             # shadcn/ui 组件配置
├── next.config.mjs             # Next.js 配置文件
├── package.json                # 项目依赖和脚本
├── pnpm-lock.yaml             # pnpm 锁文件
├── tailwind.config.ts          # Tailwind CSS 配置
├── tsconfig.json              # TypeScript 配置
└── src/                       # 源代码目录
```

### 源代码结构 (src/)

#### 1. 应用层 (src/app/)
```
src/app/
├── [locale]/                   # 国际化路由层
│   ├── (landing)/             # 公开页面组
│   │   ├── page.tsx          # 首页
│   │   ├── pricing/          # 定价页面
│   │   ├── about/            # 关于页面
│   │   ├── contact/          # 联系页面
│   │   ├── (ai)/             # AI 工具页面组
│   │   │   ├── ai-image/     # AI 图像生成
│   │   │   ├── ai-audio/     # AI 音频生成
│   │   │   ├── ai-music/     # AI 音乐生成
│   │   │   └── ai-video/     # AI 视频生成
│   │   ├── user/             # 用户相关页面
│   │   │   ├── settings/     # 用户设置
│   │   │   ├── billing/      # 账单管理
│   │   │   ├── subscription/ # 订阅管理
│   │   │   ├── profile/      # 个人资料
│   │   │   └── security/     # 安全设置
│   │   └── auth/             # 认证页面
│   │       ├── signin/       # 登录
│   │       └── signup/       # 注册
│   ├── (admin)/              # 管理后台组
│   │   ├── admin/            # 管理面板
│   │   │   ├── page.tsx     # 仪表板
│   │   │   ├── users/       # 用户管理
│   │   │   ├── orders/      # 订单管理
│   │   │   ├── payments/    # 支付管理
│   │   │   ├── posts/       # 内容管理
│   │   │   └── settings/    # 系统设置
│   │   └── layout.tsx       # 管理后台布局
│   ├── (app)/               # 应用主界面组
│   │   ├── app/            # 应用页面
│   │   └── layout.tsx      # 应用布局
│   ├── global-error.tsx    # 全局错误页面
│   ├── layout.tsx          # 根布局
│   └── not-found.tsx       # 404 页面
├── api/                    # API 路由
│   ├── auth/[...all]/     # Better-auth 认证端点
│   ├── chat/              # 聊天 API
│   ├── payment/           # 支付 API
│   ├── config/            # 配置 API
│   └── proxy/             # 代理服务 API
├── favicon.ico            # 网站图标
└── globals.css            # 全局样式
```

#### 2. 核心系统 (src/core/)
```
src/core/
├── auth/                  # 认证系统
│   ├── index.ts          # Better-auth 主实例
│   ├── config.ts         # 动态配置构建器
│   └── client.ts         # 客户端认证工具
├── db/                   # 数据库层
│   ├── index.ts         # 数据库连接管理
│   ├── config.ts        # Drizzle 配置
│   └── migration.ts     # 迁移工具
├── rbac/                 # 权限控制
│   ├── index.ts         # RBAC 核心逻辑
│   ├── permissions.ts   # 权限定义
│   └── roles.ts         # 角色管理
├── i18n/                 # 国际化
│   ├── index.ts         # next-intl 配置
│   ├── request.ts       # 请求处理
│   └── routing.ts       # 路由配置
└── theme/                # 主题系统
    ├── index.ts         # 主题管理器
    ├── config.ts        # 主题配置
    └── provider.tsx     # 主题提供者
```

#### 3. 共享模块 (src/shared/)
```
src/shared/
├── components/           # 共享组件
│   ├── ui/              # 基础 UI 组件
│   │   ├── button.tsx   # 按钮组件
│   │   ├── input.tsx    # 输入框组件
│   │   ├── dialog.tsx   # 对话框组件
│   │   └── ...          # 其他 UI 组件
│   ├── auth/            # 认证相关组件
│   ├── payment/         # 支付相关组件
│   ├── chat/            # 聊天相关组件
│   ├── forms/           # 表单组件
│   ├── layout/          # 布局组件
│   └── common/          # 通用组件
├── services/            # 业务服务层
│   ├── auth.ts         # 认证服务
│   ├── payment.ts      # 支付服务
│   ├── user.ts         # 用户服务
│   ├── order.ts        # 订单服务
│   ├── subscription.ts # 订阅服务
│   ├── credit.ts       # 积分服务
│   ├── ai.ts           # AI 服务
│   └── chat.ts         # 聊天服务
├── models/              # 数据模型
│   ├── user.ts         # 用户模型
│   ├── order.ts        # 订单模型
│   ├── subscription.ts # 订阅模型
│   └── ...             # 其他模型
├── lib/                 # 工具库
│   ├── utils.ts        # 通用工具函数
│   ├── validations.ts  # 数据验证
│   ├── constants.ts    # 常量定义
│   ├── types.ts        # 类型定义
│   └── api.ts          # API 工具
└── hooks/               # 自定义 React Hooks
    ├── use-auth.ts     # 认证 Hook
    ├── use-payment.ts  # 支付 Hook
    └── use-chat.ts     # 聊天 Hook
```

#### 4. 配置目录 (src/config/)
```
src/config/
├── index.ts              # 环境配置管理
├── db/                   # 数据库配置
│   ├── schema.ts        # 数据库表结构
│   └── migrate.ts       # 迁移脚本
├── auth/                 # 认证配置
├── payment/              # 支付配置
└── ai/                   # AI 服务配置
```

#### 5. 扩展模块 (src/extensions/)
```
src/extensions/
├── payment/              # 支付扩展
│   ├── stripe/          # Stripe 集成
│   ├── paypal/          # PayPal 集成
│   └── creem/           # Creem 集成
├── storage/              # 存储扩展
├── ai/                   # AI 提供商扩展
└── analytics/            # 分析统计扩展
```

## 数据库表结构总结

### 1. 认证相关表

#### user (用户表)
- **用途**: 存储用户基本信息
- **主要字段**:
  - `id`: 用户唯一标识
  - `name`: 用户姓名
  - `email`: 邮箱（唯一）
  - `emailVerified`: 邮箱验证状态
  - `image`: 头像
  - `createdAt/updatedAt`: 时间戳
- **索引**: 用户名搜索、注册时间排序

#### session (会话表)
- **用途**: 管理用户会话
- **主要字段**:
  - `id`: 会话 ID
  - `token`: 会话令牌（唯一）
  - `userId`: 关联用户
  - `expiresAt`: 过期时间
  - `ipAddress/userAgent`: 安全信息
- **索引**: 用户会话查询、过期时间过滤

#### account (账户关联表)
- **用途**: OAuth 账户链接
- **主要字段**:
  - `accountId/providerId`: 提供商账户信息
  - `userId`: 关联用户
  - `accessToken/refreshToken`: OAuth 令牌
  - `scope`: 权限范围
- **索引**: OAuth 登录、用户账户查询

#### verification (验证表)
- **用途**: 邮箱验证码管理
- **主要字段**:
  - `identifier`: 验证标识（如邮箱）
  - `value`: 验证码
  - `expiresAt`: 过期时间
- **索引**: 验证标识查询

### 2. 业务核心表

#### order (订单表)
- **用途**: 支付交易记录
- **主要字段**:
  - `orderNo`: 订单号（唯一）
  - `userId`: 用户 ID
  - `status`: 订单状态（created/paid/failed）
  - `amount/currency`: 金额和货币
  - `paymentProvider`: 支付提供商
  - `creditsAmount`: 积分数量
- **索引**: 用户订单状态查询、交易防重复、创建时间排序

#### subscription (订阅表)
- **用途**: 循环订阅管理
- **主要字段**:
  - `subscriptionNo`: 订阅号（唯一）
  - `userId`: 用户 ID
  - `status`: 订阅状态
  - `interval`: 计费周期
  - `currentPeriodStart/End`: 当前计费周期
- **索引**: 用户订阅状态查询、订阅防重复、创建时间排序

#### credit (积分表)
- **用途**: 积分交易记录
- **主要字段**:
  - `transactionNo`: 交易号（唯一）
  - `userId`: 用户 ID
  - `transactionType`: 交易类型（grant/consume）
  - `credits/remainingCredits`: 积分数量
  - `expiresAt`: 过期时间
- **索引**: FIFO 消费队列、订单关联、订阅关联

### 3. 内容管理表

#### post (文章表)
- **用途**: CMS 内容管理
- **主要字段**:
  - `slug`: URL 标识符（唯一）
  - `type`: 内容类型
  - `title/description/content`: 内容字段
  - `status`: 发布状态
  - `categories/tags`: 分类标签
- **索引**: 类型状态查询

#### taxonomy (分类表)
- **用途**: 层级分类系统
- **主要字段**:
  - `slug`: 分类标识符（唯一）
  - `parentId`: 父分类 ID
  - `type`: 分类类型
  - `sort`: 排序权重
- **索引**: 类型状态查询

### 4. 权限管理表 (RBAC)

#### role (角色表)
- **用途**: 角色定义
- **主要字段**:
  - `name`: 角色名称（唯一）
  - `title/description`: 显示信息
  - `status`: 角色状态
- **索引**: 状态查询

#### permission (权限表)
- **用途**: 权限定义
- **主要字段**:
  - `code`: 权限代码（唯一）
  - `resource/action`: 资源和操作
  - `title/description`: 显示信息
- **索引**: 资源操作查询

#### rolePermission (角色权限关联表)
- **用途**: 角色权限映射
- **主要字段**:
  - `roleId`: 角色 ID
  - `permissionId`: 权限 ID
- **索引**: 角色权限查询

#### userRole (用户角色关联表)
- **用途**: 用户角色分配
- **主要字段**:
  - `userId`: 用户 ID
  - `roleId`: 角色 ID
  - `expiresAt`: 过期时间
- **索引**: 用户角色查询

### 5. AI 和聊天表

#### aiTask (AI 任务表)
- **用途**: AI 生成任务跟踪
- **主要字段**:
  - `mediaType`: 媒体类型（image/audio/video）
  - `provider/model`: AI 提供商和模型
  - `prompt`: 用户提示词
  - `status`: 任务状态
  - `costCredits`: 消耗积分
- **索引**: 用户媒体类型查询、媒体类型状态查询

#### chat (聊天会话表)
- **用途**: 聊天会话管理
- **主要字段**:
  - `userId`: 用户 ID
  - `title`: 会话标题
  - `model/provider`: AI 模型信息
  - `parts`: 会话片段
- **索引**: 用户状态查询

#### chatMessage (聊天消息表)
- **用途**: 聊天消息记录
- **主要字段**:
  - `chatId`: 会话 ID
  - `role`: 消息角色（user/assistant）
  - `parts`: 消息内容
  - `model/provider`: AI 模型信息
- **索引**: 会话消息查询、用户消息查询

### 6. 系统表

#### config (配置表)
- **用途**: 系统动态配置
- **主要字段**:
  - `name`: 配置名称（唯一）
  - `value`: 配置值
- **特点**: 键值对存储，支持 OAuth、支付等动态配置

#### apikey (API 密钥表)
- **用途**: 用户 API 密钥管理
- **主要字段**:
  - `userId`: 用户 ID
  - `key`: API 密钥
  - `title`: 密钥名称
  - `status`: 密钥状态
- **索引**: 用户密钥查询、密钥验证查询

## 数据库设计特点

### 1. 性能优化
- **复合索引**: 支持复杂查询场景
- **左前缀索引**: 索引复用策略
- **查询优化**: 针对业务场景的索引设计

### 2. 数据完整性
- **外键约束**: 级联删除保证数据一致性
- **唯一约束**: 防止重复数据
- **时间戳**: 完整的审计追踪

### 3. 可扩展性
- **软删除**: 支持逻辑删除
- **版本控制**: 自动更新时间戳
- **元数据**: JSON 字段存储扩展信息

### 4. 业务逻辑
- **FIFO 积分消费**: 基于过期时间的先进先出
- **订阅生命周期**: 完整的订阅状态管理
- **权限继承**: RBAC 权限体系

这个数据库设计支持完整的 SaaS 业务流程，从用户注册、认证授权、支付订阅到内容管理和 AI 服务，提供了企业级的数据管理能力。