# ShipAny Template Two - 认证流程的代码执行逻辑

## 认证系统架构概述

ShipAny Template Two 使用 **Better-auth** 作为认证解决方案，采用动态配置和数据库驱动的设计模式。整个认证系统支持邮箱密码登录、OAuth（Google、GitHub）以及 Google One Tap 快速登录。

## 核心文件结构

```
src/core/auth/
├── index.ts          # 认证实例工厂
├── config.ts         # 动态配置构建器
├── client.ts         # 客户端认证工具
└── ...

src/app/api/auth/[...all]/
└── route.ts          # Better-auth API 路由处理器
```

## 1. 认证配置流程

### 1.1 动态配置加载 (`src/core/auth/config.ts`)

#### 静态配置
```typescript
const authOptions = {
  appName: envConfigs.app_name,
  baseURL: envConfigs.auth_url,
  secret: envConfigs.auth_secret,
  trustedOrigins: envConfigs.app_url ? [envConfigs.app_url] : [],
  advanced: {
    database: {
      generateId: () => getUuid(),  // 自定义 UUID 生成
    },
  },
  emailAndPassword: {
    enabled: true,  // 默认启用邮箱密码登录
  },
  logger: {
    verboseLogging: false,
    disabled: true,  // 构建时禁用日志
  },
};
```

#### 动态配置加载
```typescript
export async function getAuthOptions(configs: Record<string, string>) {
  return {
    ...authOptions,
    // 运行时添加数据库连接
    database: envConfigs.database_url
      ? drizzleAdapter(db(), {
          provider: getDatabaseProvider(envConfigs.database_provider),
          schema: schema,
        })
      : null,

    // 数据库钩子：用户创建后自动授予积分
    databaseHooks: {
      user: {
        create: {
          after: async (user: any) => {
            await grantCreditsForNewUser(user);
          },
        },
      },
    },

    // 基于配置启用邮箱认证
    emailAndPassword: {
      enabled: configs.email_auth_enabled !== 'false',
    },

    // 动态加载 OAuth 提供商
    socialProviders: await getSocialProviders(configs),

    // 根据配置加载插件
    plugins: configs.google_client_id && configs.google_one_tap_enabled === 'true'
      ? [oneTap()]
      : [],
  };
}
```

### 1.2 OAuth 提供商配置
```typescript
export async function getSocialProviders(configs: Record<string, string>) {
  const providers: any = {};

  // Google OAuth
  if (configs.google_client_id && configs.google_client_secret) {
    providers.google = {
      clientId: configs.google_client_id,
      clientSecret: configs.google_client_secret,
    };
  }

  // GitHub OAuth
  if (configs.github_client_id && configs.github_client_secret) {
    providers.github = {
      clientId: configs.github_client_id,
      clientSecret: configs.github_client_secret,
    };
  }

  return providers;
}
```

## 2. 认证实例创建流程

### 2.1 服务器端认证实例 (`src/core/auth/index.ts`)

```typescript
export async function getAuth() {
  // 1. 从数据库获取动态配置
  const configs = await getAllConfigs();

  // 2. 构建认证选项
  const authOptions = await getAuthOptions(configs);

  // 3. 创建 Better-auth 实例
  return betterAuth(authOptions);
}
```

**执行流程**:
1. **配置加载**: 从 `config` 表获取 OAuth 密钥和功能开关
2. **选项构建**: 合并静态配置和动态配置
3. **实例创建**: 创建 Better-auth 实例
4. **返回实例**: 供 API 路由使用

### 2.2 客户端认证实例 (`src/core/auth/client.ts`)

```typescript
// 默认客户端（无插件）
export const authClient = createAuthClient({
  baseURL: envConfigs.auth_url,
});

// 导出常用方法
export const { useSession, signIn, signUp, signOut } = authClient;

// 动态客户端（带插件）
export function getAuthClient(configs: Record<string, string>) {
  const authClient = createAuthClient({
    baseURL: envConfigs.auth_url,
    plugins: getAuthPlugins(configs),
  });

  return authClient;
}
```

## 3. API 路由处理流程

### 3.1 认证 API 端点 (`src/app/api/auth/[...all]/route.ts`)

```typescript
export async function POST(request: Request) {
  // 1. 获取认证实例
  const auth = await getAuth();

  // 2. 创建 Next.js 处理器
  const handler = toNextJsHandler(auth.handler);

  // 3. 处理 POST 请求
  return handler.POST(request);
}

export async function GET(request: Request) {
  // 1. 获取认证实例
  const auth = await getAuth();

  // 2. 创建 Next.js 处理器
  const handler = toNextJsHandler(auth.handler);

  // 3. 处理 GET 请求
  return handler.GET(request);
}
```

**处理的端点包括**:
- `/api/auth/signin` - 登录
- `/api/auth/signup` - 注册
- `/api/auth/signout` - 登出
- `/api/auth/session` - 会话验证
- `/api/auth/callback/google` - Google OAuth 回调
- `/api/auth/callback/github` - GitHub OAuth 回调

## 4. 用户认证生命周期

### 4.1 用户注册流程

```
1. 用户提交注册信息 (邮箱/密码 或 OAuth)
   ↓
2. Better-auth 验证用户信息
   ↓
3. 创建用户记录到 `user` 表
   ↓
4. 触发 `databaseHooks.user.create.after`
   ↓
5. 自动授予新用户积分 (`grantCreditsForNewUser`)
   ↓
6. 创建用户会话
   ↓
7. 返回认证结果
```

### 4.2 用户登录流程

```
邮箱密码登录:
1. 用户提交邮箱密码
   ↓
2. Better-auth 验证凭据
   ↓
3. 创建会话记录到 `session` 表
   ↓
4. 设置认证 Cookie
   ↓
5. 返回用户信息

OAuth 登录:
1. 重定向到 OAuth 提供商
   ↓
2. 用户授权后回调到 `/api/auth/callback/{provider}`
   ↓
3. Better-auth 验证授权码
   ↓
4. 查找或创建用户记录
   ↓
5. 创建或更新 `account` 关联记录
   ↓
6. 创建用户会话
   ↓
7. 重定向到应用主页
```

### 4.3 会话验证流程

```
1. 客户端发送带 Cookie 的请求
   ↓
2. Better-auth 中间件验证会话令牌
   ↓
3. 查询 `session` 表验证有效性
   ↓
4. 检查过期时间
   ↓
5. 返回用户信息或 401 错误
```

## 5. 数据库交互流程

### 5.1 认证相关数据表

- **`user`**: 用户基本信息
- **`session`**: 用户会话管理
- **`account`**: OAuth 账户关联
- **`verification`**: 邮箱验证码

### 5.2 数据库适配器配置

```typescript
database: drizzleAdapter(db(), {
  provider: getDatabaseProvider(envConfigs.database_provider),
  schema: schema,
})
```

**支持的数据库**:
- PostgreSQL (`pg`)
- SQLite (`sqlite`)
- MySQL (`mysql`)

### 5.3 会话存储机制

```typescript
// 会话创建
session: {
  id: "唯一会话ID",
  token: "会话令牌",
  userId: "用户ID",
  expiresAt: "过期时间",
  ipAddress: "客户端IP",
  userAgent: "用户代理"
}
```

## 6. 安全特性

### 6.1 令牌安全
- **会话令牌**: 随机生成的安全令牌
- **过期机制**: 自动过期清理
- **IP 跟踪**: 记录客户端 IP 地址
- **设备跟踪**: 记录用户代理信息

### 6.2 OAuth 安全
- **状态验证**: 防止 CSRF 攻击
- **授权码验证**: 安全的授权码交换
- **令牌管理**: 安全的访问令牌存储

### 6.3 配置安全
- **环境隔离**: 敏感配置通过环境变量
- **动态配置**: 运行时数据库配置
- **权限验证**: 基于 RBAC 的权限控制

## 7. 客户端集成

### 7.1 React Hook 使用

```typescript
import { useSession } from '@/core/auth/client';

function UserProfile() {
  const { data: session, isPending } = useSession();

  if (isPending) return <div>Loading...</div>;

  if (!session) return <div>Please sign in</div>;

  return <div>Welcome, {session.user.name}</div>;
}
```

### 7.2 登录组件

```typescript
import { signIn, signOut } from '@/core/auth/client';

function AuthButton() {
  const handleSignIn = async () => {
    await signIn.email({
      email: 'user@example.com',
      password: 'password'
    });
  };

  const handleOAuthSignIn = async () => {
    await signIn.social({
      provider: 'google'
    });
  };
}
```

## 8. Google One Tap 集成

### 8.1 服务器端配置

```typescript
plugins: configs.google_client_id && configs.google_one_tap_enabled === 'true'
  ? [oneTap()]
  : []
```

### 8.2 客户端配置

```typescript
oneTapClient({
  clientId: configs.google_client_id,
  autoSelect: false,
  cancelOnTapOutside: false,
  context: 'signin',
  promptOptions: {
    baseDelay: 1000,
    maxAttempts: 1,
  },
})
```

## 9. 错误处理和日志

### 9.1 认证错误处理
- **验证失败**: 返回 401 Unauthorized
- **会话过期**: 自动清理过期会话
- **OAuth 错误**: 处理提供商错误响应

### 9.2 新用户积分授予

```typescript
databaseHooks: {
  user: {
    create: {
      after: async (user: any) => {
        try {
          await grantCreditsForNewUser(user);
        } catch (e) {
          console.log('grant credits for new user failed', e);
        }
      },
    },
  },
}
```

## 10. 配置管理流程

### 10.1 环境变量
- `AUTH_SECRET`: 32 字符认证密钥
- `DATABASE_URL`: 数据库连接字符串
- `NEXT_PUBLIC_APP_URL`: 应用 URL

### 10.2 数据库配置
通过 `config` 表动态管理:
- `google_client_id/google_client_secret`: Google OAuth
- `github_client_id/github_client_secret`: GitHub OAuth
- `email_auth_enabled`: 邮箱认证开关
- `google_one_tap_enabled`: One Tap 开关

这种设计实现了高度可配置的认证系统，支持运行时配置更改，无需重启应用即可调整认证策略。