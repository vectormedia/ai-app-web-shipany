# ShipAny Template Two - 页面路由管理

## 路由系统架构概述

ShipAny Template Two 采用 **Next.js 15 App Router** 架构，结合 **next-intl** 国际化框架，实现了多语言支持的动态路由系统。整个路由系统基于文件系统路由，支持路由组、动态路由和嵌套布局。

## 核心文件结构

```
src/
├── app/
│   ├── [locale]/              # 国际化路由层
│   │   ├── layout.tsx        # 语言布局包装器
│   │   ├── (landing)/        # 公开页面路由组
│   │   ├── (admin)/          # 管理后台路由组
│   │   ├── (auth)/           # 认证页面路由组
│   │   ├── (chat)/           # 聊天应用路由组
│   │   └── (docs)/           # 文档页面路由组
│   └── api/                  # API 路由
├── core/i18n/                # 国际化配置
└── config/locale/            # 语言配置
```

## 1. 国际化路由配置

### 1.1 语言配置 (`src/config/locale/index.ts`)

```typescript
export const localeNames: any = {
  en: 'English',
  zh: '中文',
};

export const locales = ['en', 'zh'];              // 支持的语言列表
export const defaultLocale = envConfigs.locale;    // 默认语言
export const localePrefix = 'as-needed';           // URL 前缀策略
export const localeDetection = false;              // 禁用自动语言检测
```

**URL 路由模式**:
- `/en/` - 英文页面
- `/zh/` - 中文页面
- `/` - 重定向到默认语言

### 1.2 路由定义 (`src/core/i18n/config.ts`)

```typescript
import { defineRouting } from 'next-intl/routing';

export const routing = defineRouting({
  locales,          // 支持的语言
  defaultLocale,    // 默认语言
  localePrefix,     // 前缀策略
  localeDetection,  // 语言检测
});
```

### 1.3 导航工具 (`src/core/i18n/navigation.ts`)

```typescript
import { createNavigation } from 'next-intl/navigation';

export const {
  Link,           // 国际化链接组件
  redirect,       // 重定向函数
  usePathname,    // 获取当前路径
  useRouter,      // 路由导航
  getPathname     // 服务器端路径获取
} = createNavigation(routing);
```

## 2. 路由组架构

### 2.1 路由组概念
使用 `(groupName)` 语法创建路由组，不影响 URL 结构但提供逻辑分组和独立布局：

```
src/app/[locale]/
├── (landing)/     # 公开页面组 - 主要用户界面
├── (admin)/       # 管理后台组 - 后台管理界面
├── (auth)/        # 认证页面组 - 登录注册页面
├── (chat)/        # 聊天应用组 - AI 聊天界面
└── (docs)/        # 文档页面组 - 帮助文档
```

### 2.2 Landing 路由组 (`(landing)/`)

**结构**:
```
(landing)/
├── layout.tsx              # Landing 布局
├── page.tsx                # 首页
├── pricing/                # 定价页面
├── about/                  # 关于页面
├── contact/                # 联系页面
├── (ai)/                   # AI 工具子组
│   ├── ai-image-generator/ # AI 图像生成
│   ├── ai-audio-generator/ # AI 音频生成
│   ├── ai-music-generator/ # AI 音乐生成
│   ├── ai-video-generator/ # AI 视频生成
│   └── ai-chatbot/         # AI 聊天机器人
├── settings/               # 用户设置
│   ├── profile/           # 个人资料
│   ├── security/          # 安全设置
│   ├── billing/           # 账单管理
│   ├── payments/          # 支付管理
│   ├── credits/           # 积分管理
│   └── apikeys/           # API 密钥管理
└── activity/              # 用户活动
    ├── ai-tasks/          # AI 任务历史
    └── chats/             # 聊天历史
```

**布局特点**:
```typescript
export default async function LandingLayout({ children }: { children: ReactNode }) {
  const t = await getTranslations('landing');

  // 动态主题布局加载
  const Layout = await getThemeLayout('landing');

  const header: HeaderType = t.raw('header');
  const footer: FooterType = t.raw('footer');

  return (
    <Layout header={header} footer={footer}>
      <LocaleDetector />  {/* 语言检测器 */}
      {children}
    </Layout>
  );
}
```

### 2.3 Admin 路由组 (`(admin)/`)

**结构**:
```
(admin)/
├── layout.tsx              # Admin 布局
└── admin/                  # 管理页面
    ├── page.tsx           # 仪表板
    ├── users/             # 用户管理
    ├── orders/            # 订单管理
    ├── payments/          # 支付管理
    ├── posts/             # 内容管理
    ├── roles/             # 角色管理
    ├── permissions/       # 权限管理
    ├── ai-tasks/          # AI 任务管理
    ├── chats/             # 聊天管理
    └── settings/          # 系统设置
```

### 2.4 Auth 路由组 (`(auth)/`)

**结构**:
```
(auth)/
├── layout.tsx             # 认证布局
├── sign-in/               # 登录页面
└── sign-up/               # 注册页面
```

## 3. 动态主题系统

### 3.1 主题架构

```typescript
// 主题获取函数
export function getActiveTheme(): string {
  return envConfigs.theme || defaultTheme;
}

// 主题布局加载
export async function getThemeLayout(layoutName: string, theme?: string) {
  const loadTheme = theme || getActiveTheme();

  try {
    const module = await import(`@/themes/${loadTheme}/layouts/${layoutName}`);
    return module.default;
  } catch (error) {
    // 自动降级到默认主题
    if (loadTheme !== defaultTheme) {
      const fallbackModule = await import(
        `@/themes/${defaultTheme}/layouts/${layoutName}`
      );
      return fallbackModule.default;
    }
    throw error;
  }
}
```

### 3.2 主题目录结构

```
src/themes/
├── default/               # 默认主题
│   ├── layouts/          # 布局组件
│   │   ├── landing.tsx   # Landing 布局
│   │   ├── admin.tsx     # Admin 布局
│   │   └── auth.tsx      # Auth 布局
│   ├── pages/            # 页面组件
│   └── blocks/           # 区块组件
└── custom/               # 自定义主题
    ├── layouts/
    ├── pages/
    └── blocks/
```

### 3.3 主题组件加载

```typescript
// 页面组件加载
export async function getThemePage(pageName: string, theme?: string) {
  const module = await import(`@/themes/${theme}/pages/${pageName}`);
  return module.default;
}

// 区块组件加载
export async function getThemeBlock(blockName: string, theme?: string) {
  const module = await import(`@/themes/${theme}/blocks/${blockName}`);
  const pascalCaseName = kebabToPascalCase(blockName);
  return module[pascalCaseName] || module[blockName];
}
```

## 4. 布局系统

### 4.1 布局层次结构

```
Root Layout (app/layout.tsx)
├── Locale Layout (app/[locale]/layout.tsx)
    ├── Landing Layout ((landing)/layout.tsx)
    │   ├── Settings Layout (settings/layout.tsx)
    │   └── Activity Layout (activity/layout.tsx)
    ├── Admin Layout ((admin)/layout.tsx)
    ├── Auth Layout ((auth)/layout.tsx)
    ├── Chat Layout ((chat)/layout.tsx)
    └── Docs Layout ((docs)/layout.tsx)
```

### 4.2 Locale Layout (`app/[locale]/layout.tsx`)

```typescript
export default async function LocaleLayout({
  children,
  params,
}: {
  children: React.ReactNode;
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;

  // 验证语言有效性
  if (!hasLocale(routing.locales, locale)) {
    notFound();
  }

  // 设置请求语言环境
  setRequestLocale(locale);

  return (
    <NextIntlClientProvider>
      <ThemeProvider>
        <AppContextProvider>
          {children}
          <Toaster position="top-center" richColors />
        </AppContextProvider>
      </ThemeProvider>
    </NextIntlClientProvider>
  );
}
```

### 4.3 嵌套布局示例

**Settings Layout**:
```typescript
export default async function SettingsLayout({
  children,
}: {
  children: ReactNode;
}) {
  const t = await getTranslations('settings/sidebar');

  return (
    <div className="container mx-auto px-4 py-8">
      <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <div className="lg:col-span-1">
          <Sidebar items={t.raw('items')} />
        </div>
        <div className="lg:col-span-3">
          {children}
        </div>
      </div>
    </div>
  );
}
```

## 5. 动态路由和参数

### 5.1 动态路由模式

- `[id]` - 单个动态段：`/users/[id]`
- `[...slug]` - 捕获所有段：`/api/auth/[...all]`
- `[[...slug]]` - 可选捕获：`/posts/[[...slug]]`

### 5.2 路由参数获取

```typescript
// 页面组件中获取参数
export default async function UserPage({
  params,
}: {
  params: Promise<{ id: string; locale: string }>;
}) {
  const { id, locale } = await params;

  // 使用参数
  const user = await getUserById(id);

  return <UserProfile user={user} />;
}
```

### 5.3 搜索参数处理

```typescript
// URL: /search?q=keyword&page=2
export default async function SearchPage({
  searchParams,
}: {
  searchParams: Promise<{ q?: string; page?: string }>;
}) {
  const { q, page } = await searchParams;

  return <SearchResults query={q} page={Number(page) || 1} />;
}
```

## 6. 路由保护和权限

### 6.1 认证保护

```typescript
// 需要登录的页面
export default async function ProtectedPage() {
  const session = await getSession();

  if (!session) {
    redirect('/sign-in');
  }

  return <ProtectedContent user={session.user} />;
}
```

### 6.2 角色权限保护

```typescript
// 管理员权限检查
export default async function AdminPage() {
  const session = await getSession();
  const hasPermission = await checkPermission(session?.user.id, 'admin.access');

  if (!hasPermission) {
    notFound();
  }

  return <AdminDashboard />;
}
```

## 7. 导航组件

### 7.1 国际化链接

```typescript
import { Link } from '@/core/i18n/navigation';

function Navigation() {
  return (
    <nav>
      <Link href="/">Home</Link>
      <Link href="/about">About</Link>
      <Link href="/pricing">Pricing</Link>
    </nav>
  );
}
```

### 7.2 程序式导航

```typescript
import { useRouter } from '@/core/i18n/navigation';

function NavigationComponent() {
  const router = useRouter();

  const handleNavigation = () => {
    router.push('/dashboard');
    // 自动保持当前语言环境
  };

  return <button onClick={handleNavigation}>Go to Dashboard</button>;
}
```

## 8. 元数据和 SEO

### 8.1 动态元数据

```typescript
import { getMetadata } from '@/shared/lib/seo';

export const generateMetadata = getMetadata({
  title: 'Page Title',
  description: 'Page Description',
  keywords: ['keyword1', 'keyword2'],
});
```

### 8.2 语言相关元数据

```typescript
export async function generateMetadata({
  params,
}: {
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;
  const t = await getTranslations({ locale, namespace: 'metadata' });

  return {
    title: t('title'),
    description: t('description'),
    alternates: {
      languages: {
        en: '/en',
        zh: '/zh',
      },
    },
  };
}
```

## 9. 错误处理

### 9.1 404 页面

```typescript
// app/[locale]/not-found.tsx
export default function NotFound() {
  return (
    <div>
      <h2>Not Found</h2>
      <p>Could not find requested resource</p>
      <Link href="/">Return Home</Link>
    </div>
  );
}
```

### 9.2 全局错误处理

```typescript
// app/[locale]/global-error.tsx
export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  return (
    <html>
      <body>
        <h2>Something went wrong!</h2>
        <button onClick={() => reset()}>Try again</button>
      </body>
    </html>
  );
}
```

## 10. 路由性能优化

### 10.1 静态生成

```typescript
// 生成静态路由
export function generateStaticParams() {
  return [
    { locale: 'en' },
    { locale: 'zh' },
  ];
}
```

### 10.2 增量静态再生成

```typescript
export const revalidate = 3600; // 1 hour
```

### 10.3 并行路由

```
app/[locale]/(dashboard)/
├── @analytics/page.tsx    # 并行段
├── @stats/page.tsx        # 并行段
└── layout.tsx             # 接收并行段
```

```typescript
export default function DashboardLayout({
  children,
  analytics,
  stats,
}: {
  children: React.ReactNode;
  analytics: React.ReactNode;
  stats: React.ReactNode;
}) {
  return (
    <div>
      {children}
      <div className="grid grid-cols-2">
        {analytics}
        {stats}
      </div>
    </div>
  );
}
```

## 11. 路由调试和监控

### 11.1 路由日志

```typescript
// 在布局中记录路由信息
export default function Layout({ children }: { children: ReactNode }) {
  if (process.env.NODE_ENV === 'development') {
    console.log('Current route:', window.location.pathname);
  }

  return <>{children}</>;
}
```

### 11.2 路由分析

```typescript
// 使用 usePathname 跟踪路由变化
import { usePathname } from '@/core/i18n/navigation';

function RouteTracker() {
  const pathname = usePathname();

  useEffect(() => {
    // 发送路由分析数据
    analytics.track('page_view', { path: pathname });
  }, [pathname]);

  return null;
}
```

这个路由系统提供了灵活、可扩展的页面管理能力，支持多语言、主题化、权限控制和性能优化，为构建复杂的现代 web 应用提供了坚实的基础。