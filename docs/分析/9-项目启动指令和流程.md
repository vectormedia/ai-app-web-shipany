# ShipAny Template Two - 项目启动指令和流程

## 项目概述

ShipAny Template Two 是一个基于 Next.js 15、React 19 和 TypeScript 的现代化 AI SaaS 应用模板。支持多种部署方式（Vercel、Cloudflare、Docker）和多种支付提供商（Stripe、PayPal、Creem）。

## 技术栈信息

### 核心依赖
- **Next.js**: 16.0.7 (App Router)
- **React**: 19.2.1
- **TypeScript**: 5.x
- **Node.js**: 推荐 18+ 或 20+
- **包管理器**: pnpm (推荐)

### 主要特性
- **Turbopack**: 快速开发构建
- **国际化**: next-intl 支持多语言
- **认证**: Better-auth 认证系统
- **数据库**: Drizzle ORM + PostgreSQL
- **支付**: 多提供商支持
- **AI 集成**: 多种 AI 服务提供商

## 1. 环境要求

### 1.1 系统要求

```bash
# Node.js 版本
node --version    # v18.0.0+

# pnpm 版本
pnpm --version    # v8.0.0+

# 数据库
PostgreSQL 13+    # 推荐
# 或 SQLite (开发环境)
# 或 MySQL 8.0+
```

### 1.2 开发工具推荐

```bash
# 推荐编辑器
Visual Studio Code

# 推荐插件
- TypeScript Hero
- Prettier - Code formatter
- ESLint
- Tailwind CSS IntelliSense
- Better Comments
```

## 2. 快速开始

### 2.1 克隆项目

```bash
# 克隆仓库
git clone https://github.com/shipanyai/shipany-template-two.git
cd shipany-template-two

# 或下载压缩包解压
```

### 2.2 安装依赖

```bash
# 使用 pnpm (推荐)
pnpm install

# 或使用 npm
npm install

# 或使用 yarn
yarn install
```

### 2.3 环境配置

```bash
# 1. 复制环境变量模板
cp .env.example .env.local

# 2. 编辑环境变量
nano .env.local
# 或
code .env.local
```

#### 必需环境变量

```bash
# 应用基本配置
NEXT_PUBLIC_APP_URL = "http://localhost:3000"
NEXT_PUBLIC_APP_NAME = "Your App Name"

# 数据库连接 (必需)
DATABASE_URL = "postgresql://user:password@localhost:5432/dbname"
DATABASE_PROVIDER = "postgresql"
DB_SINGLETON_ENABLED = "true"

# 认证密钥 (必需)
AUTH_SECRET = "your-32-character-secret"
```

#### 生成认证密钥

```bash
# 生成 32 字符密钥
openssl rand -base64 32

# 或使用 Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

### 2.4 数据库设置

#### PostgreSQL 设置

```bash
# 1. 安装 PostgreSQL
# macOS
brew install postgresql
brew services start postgresql

# Ubuntu/Debian
sudo apt update
sudo apt install postgresql postgresql-contrib

# 2. 创建数据库
createdb shipany_db

# 3. 创建用户 (可选)
psql -c "CREATE USER shipany WITH PASSWORD 'your_password';"
psql -c "GRANT ALL PRIVILEGES ON DATABASE shipany_db TO shipany;"

# 4. 更新 DATABASE_URL
DATABASE_URL="postgresql://shipany:your_password@localhost:5432/shipany_db"
```

#### SQLite 设置 (开发环境)

```bash
# 更新环境变量
DATABASE_URL="file:./dev.db"
DATABASE_PROVIDER="sqlite"
```

### 2.5 数据库迁移

```bash
# 生成迁移文件
pnpm db:generate

# 运行迁移
pnpm db:migrate

# 或直接推送 schema (开发环境)
pnpm db:push
```

### 2.6 启动开发服务器

```bash
# 启动开发服务器 (使用 Turbopack)
pnpm dev

# 应用将在 http://localhost:3000 启动
```

## 3. 开发命令详解

### 3.1 核心开发命令

```bash
# 开发服务器
pnpm dev              # 启动开发服务器 (Turbopack)
pnpm build            # 生产环境构建
pnpm build:fast       # 快速构建 (增加内存限制)
pnpm start            # 启动生产服务器
```

### 3.2 数据库操作命令

```bash
# 数据库迁移
pnpm db:generate      # 生成 Drizzle 迁移文件
pnpm db:migrate       # 执行数据库迁移
pnpm db:push          # 推送 schema 变更 (开发环境)
pnpm db:studio        # 打开 Drizzle Studio (数据库管理界面)

# 示例流程
pnpm db:generate      # 修改 schema 后生成迁移
pnpm db:migrate       # 应用迁移到数据库
```

### 3.3 代码质量命令

```bash
# 代码检查和格式化
pnpm lint             # 运行 ESLint 检查
pnpm format           # 使用 Prettier 格式化代码
pnpm format:check     # 检查代码格式 (CI 环境)

# 修复代码问题
pnpm lint --fix       # 自动修复 ESLint 问题
```

### 3.4 认证和权限命令

```bash
# Better-auth 相关
pnpm auth:generate    # 生成 Better-auth 配置

# RBAC 权限管理
pnpm rbac:init        # 初始化角色权限数据
pnpm rbac:assign      # 分配用户角色

# 示例：初始化管理员
pnpm rbac:init        # 创建基础角色和权限
pnpm rbac:assign      # 分配管理员角色给用户
```

### 3.5 部署相关命令

#### Cloudflare 部署

```bash
# Cloudflare Workers 部署
pnpm cf:preview       # 预览 Cloudflare 部署
pnpm cf:deploy        # 部署到 Cloudflare
pnpm cf:upload        # 上传到 Cloudflare
pnpm cf:typegen       # 生成 Cloudflare 类型定义
```

#### Vercel 部署

```bash
# Vercel 部署 (需要 Vercel CLI)
npm i -g vercel       # 安装 Vercel CLI
vercel                # 部署到 Vercel
vercel --prod         # 生产环境部署
```

### 3.6 文档相关命令

```bash
# MDX 文档处理
pnpm postinstall      # 处理 fumadocs-mdx (自动执行)

# 开发时重新处理文档
npx fumadocs-mdx
```

## 4. 开发流程

### 4.1 首次启动流程

```bash
# 1. 项目初始化
git clone <repository>
cd shipany-template-two
pnpm install

# 2. 环境配置
cp .env.example .env.local
# 编辑 .env.local 设置必需变量

# 3. 数据库设置
# 创建数据库
pnpm db:push          # 开发环境快速设置

# 4. 初始化数据 (可选)
pnpm rbac:init        # 创建角色权限
# 手动创建管理员用户

# 5. 启动开发
pnpm dev
```

### 4.2 日常开发流程

```bash
# 1. 启动开发环境
pnpm dev              # 在一个终端启动开发服务器

# 2. 数据库管理 (可选)
pnpm db:studio        # 在另一个终端打开数据库管理界面

# 3. 代码开发
# 修改代码...

# 4. 数据库变更 (如需要)
# 修改 src/config/db/schema.ts
pnpm db:generate      # 生成迁移
pnpm db:migrate       # 应用迁移

# 5. 代码质量检查
pnpm lint             # 检查代码问题
pnpm format           # 格式化代码

# 6. 提交代码
git add .
git commit -m "feat: add new feature"
git push
```

### 4.3 构建和部署流程

```bash
# 1. 本地测试构建
pnpm build            # 构建生产版本
pnpm start            # 本地测试生产版本

# 2. 代码质量检查
pnpm lint             # 确保无 ESLint 错误
pnpm format:check     # 确保代码格式正确

# 3. 部署 (选择一种方式)

# Vercel 部署
vercel --prod

# Cloudflare 部署
pnpm cf:deploy

# Docker 部署
docker build -t shipany-app .
docker run -p 3000:3000 shipany-app
```

## 5. 开发环境启动详细流程

### 5.1 服务器启动过程

```bash
pnpm dev 执行流程:

1. 读取配置文件
   ├── next.config.mjs
   ├── tailwind.config.ts
   ├── tsconfig.json
   └── .env.local

2. 启动 Next.js 开发服务器
   ├── 启用 Turbopack (--turbopack)
   ├── 热重载监听
   └── 端口监听 (默认 3000)

3. 编译和构建
   ├── TypeScript 类型检查
   ├── Tailwind CSS 处理
   ├── MDX 文档处理
   └── 动态导入处理

4. 服务就绪
   ├── 本地服务: http://localhost:3000
   ├── 网络服务: http://192.168.x.x:3000
   └── 热重载已启用
```

### 5.2 首次访问流程

```
用户访问 http://localhost:3000 时:

1. Next.js 路由解析
   ├── 匹配 app/[locale] 路由
   ├── 语言检测 (默认 'en')
   └── 加载对应页面

2. 服务端渲染
   ├── 执行布局组件
   ├── 执行页面组件
   ├── 获取国际化内容
   └── 生成 HTML

3. 客户端水合
   ├── React 组件激活
   ├── 事件监听器绑定
   ├── AppContext 初始化
   └── 状态管理激活

4. 应用就绪
   ├── 界面交互可用
   ├── 语言检测完成
   └── 全局状态同步
```

## 6. 故障排除

### 6.1 常见启动问题

#### 端口占用

```bash
# 问题: EADDRINUSE: address already in use :::3000
# 解决:
lsof -ti:3000 | xargs kill -9  # 杀死占用进程
# 或指定其他端口
pnpm dev -- --port 3001
```

#### 依赖安装问题

```bash
# 问题: 依赖安装失败
# 解决:
rm -rf node_modules package-lock.json
pnpm install

# Node.js 版本问题
nvm install 18    # 安装 Node.js 18
nvm use 18        # 切换到 Node.js 18
```

#### 数据库连接问题

```bash
# 问题: database connection failed
# 解决:
1. 检查数据库服务是否启动
   brew services start postgresql  # macOS

2. 检查连接字符串
   DATABASE_URL="postgresql://user:pass@localhost:5432/db"

3. 测试连接
   psql $DATABASE_URL -c "SELECT 1;"

4. 检查防火墙设置
```

#### 环境变量问题

```bash
# 问题: AUTH_SECRET not set
# 解决:
1. 检查 .env.local 文件是否存在
2. 生成新的密钥
   openssl rand -base64 32
3. 重启开发服务器
   pnpm dev
```

### 6.2 构建问题

#### TypeScript 错误

```bash
# 问题: Type check failed
# 解决:
1. 检查类型错误
   npx tsc --noEmit

2. 修复类型问题
   # 根据错误信息修复

3. 清理缓存
   rm -rf .next
   pnpm build
```

#### 内存不足

```bash
# 问题: FATAL ERROR: Ineffective mark-compacts near heap limit
# 解决:
pnpm build:fast   # 使用增加内存限制的构建命令
# 或手动设置
NODE_OPTIONS='--max-old-space-size=4096' pnpm build
```

### 6.3 性能优化

#### 开发环境优化

```bash
# 1. 使用 Turbopack
pnpm dev           # 已默认启用

# 2. 增加内存限制
export NODE_OPTIONS='--max-old-space-size=4096'

# 3. 清理缓存
rm -rf .next
rm -rf node_modules/.cache
```

#### 数据库优化

```bash
# 1. 开发环境使用 db:push
pnpm db:push       # 而不是 migrate

# 2. 启用单例模式
DB_SINGLETON_ENABLED = "true"

# 3. 使用连接池
# 在 DATABASE_URL 中添加连接池参数
DATABASE_URL="postgresql://...?pool_timeout=30"
```

## 7. 高级配置

### 7.1 自定义域名

```bash
# 开发环境自定义域名
# 1. 编辑 hosts 文件
sudo nano /etc/hosts
# 添加: 127.0.0.1 myapp.local

# 2. 启动服务器
pnpm dev -- --hostname myapp.local

# 访问: http://myapp.local:3000
```

### 7.2 HTTPS 开发环境

```bash
# 使用 mkcert 创建本地证书
brew install mkcert       # macOS
mkcert -install
mkcert localhost

# 配置 Next.js HTTPS (需要自定义服务器)
```

### 7.3 环境变量管理

```bash
# 不同环境配置
.env                      # 默认配置
.env.local               # 本地覆盖 (git ignore)
.env.development         # 开发环境
.env.production          # 生产环境

# 优先级 (高到低):
# .env.local > .env.development > .env
```

## 8. 团队开发设置

### 8.1 代码规范

```bash
# 安装 pre-commit hooks
npx husky add .husky/pre-commit "pnpm lint && pnpm format:check"

# 配置编辑器
# .vscode/settings.json
{
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode"
}
```

### 8.2 数据库协作

```bash
# 1. 使用迁移而非 push
pnpm db:generate      # 生成迁移文件
git add migrations/   # 提交迁移文件

# 2. 团队成员应用迁移
git pull
pnpm db:migrate       # 应用新迁移
```

### 8.3 环境变量模板

```bash
# 维护 .env.example
# 包含所有必需变量的示例值
# 定期更新确保与项目需求同步

# 团队成员设置
cp .env.example .env.local
# 根据个人环境配置具体值
```

## 总结

ShipAny Template Two 提供了完整的开发环境设置和启动流程：

1. **快速启动**: `pnpm install` → `配置环境` → `pnpm dev`
2. **数据库管理**: 强大的 Drizzle ORM 和迁移系统
3. **开发体验**: Turbopack 快速构建和热重载
4. **代码质量**: ESLint + Prettier 代码规范
5. **部署支持**: 多种部署方式和环境配置

遵循本指南可以快速搭建开发环境并开始项目开发。